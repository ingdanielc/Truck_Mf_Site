<div class="offcanvas-header p-4 pb-2 d-flex flex-column border-bottom">
  <div class="d-flex justify-content-between align-items-start w-100">
    <div>
      <h2 class="h4 fw-bold mb-0 text-body">Agregar Gasto</h2>
    </div>
    <button
      type="button"
      class="btn btn-link text-body p-0 border-0 shadow-none mt-n2"
      (click)="dismiss()"
      aria-label="Cerrar"
    >
      <i class="fa-solid fa-xmark fs-3"></i>
    </button>
  </div>
  <p class="text-secondary small mb-0 mt-1">
    Registra un nuevo movimiento financiero.
  </p>
</div>

<div class="offcanvas-body p-4 custom-scrollbar">
  <form [formGroup]="expenseForm" (ngSubmit)="onSave()">
    <!-- Type Selection -->
    <div class="mb-4">
      <label for="" class="form-label fw-bold small text-body mb-3"
        >Tipo de Gasto*</label
      >
      <div
        class="d-flex gap-2 justify-content-center flex-nowrap overflow-auto"
      >
        @for (type of expenseTypes; track type.id) {
          <button
            type="button"
            class="btn rounded-pill px-3 px-sm-4 fw-medium text-nowrap"
            [ngClass]="
              type.id === selectedType
                ? 'btn-primary'
                : 'btn-white border bg-white text-secondary'
            "
            (click)="selectType(type.id)"
          >
            {{ type.label }}
          </button>
        }
      </div>
    </div>

    <!-- Category Selection -->
    <div class="mb-4">
      <label for="" class="form-label fw-bold small text-body mb-3"
        >Selecciona una categoría*</label
      >

      <!-- Search Input -->
      <div class="input-group mb-3 custom-search">
        <span
          class="input-group-text bg-white border-end-0 text-secondary ps-3 pe-2"
        >
          <i class="fa-solid fa-magnifying-glass"></i>
        </span>
        <input
          type="text"
          class="form-control border-start-0 ps-0 shadow-none"
          placeholder="Buscar categoría..."
          (input)="onSearchChange($event)"
          [value]="searchQuery"
        />
      </div>

      <!-- Categories Grid -->
      @if (loadingCategories) {
        <div class="text-center py-4">
          <div
            class="spinner-border text-primary spinner-border-sm"
            role="status"
          ></div>
          <p class="small text-secondary mt-2">Cargando categorías...</p>
        </div>
      } @else {
        <div class="row g-2">
          @for (category of filteredCategories; track category.id) {
            <div class="col-4">
              <g-expense-category-card
                [icon]="category.icon"
                [name]="category.name"
                [colorClass]="category.colorClass"
                [selected]="selectedCategoryId === category.id"
                (cardClick)="selectCategory(category.id)"
                class="h-100"
              ></g-expense-category-card>
            </div>
          }
          <!-- New Category Card -->
          <div class="col-4">
            <g-expense-category-card
              icon="fa-solid fa-plus"
              name="Nueva"
              [isNew]="true"
              colorClass="text-primary bg-primary"
              (cardClick)="selectCategory(-1)"
              class="h-100"
            ></g-expense-category-card>
          </div>
        </div>
      }

      @if (
        expenseForm.get("categoryId")?.touched &&
        expenseForm.get("categoryId")?.invalid
      ) {
        <div class="text-danger small mt-2">
          Por favor selecciona una categoría.
        </div>
      }
    </div>

    <!-- Amount Input -->
    <div class="mb-4">
      <label for="" class="form-label fw-bold small text-body mb-2"
        >Monto total ($)*</label
      >
      <div
        class="input-group input-group-lg no-border-input-group bg-white rounded-3 overflow-hidden shadow-sm"
      >
        <span
          class="input-group-text bg-transparent border-0 text-primary fw-bold fs-4 ps-4"
          >$</span
        >
        <input
          type="number"
          class="form-control border-0 shadow-none fs-4 text-secondary py-3"
          placeholder="0.00"
          formControlName="amount"
        />
      </div>
      @if (
        expenseForm.get("amount")?.touched && expenseForm.get("amount")?.invalid
      ) {
        <div class="text-danger small mt-2">
          Ingresa un monto válido mayor a cero.
        </div>
      }
    </div>

    <!-- Description Input -->
    <div class="mb-5">
      <label class="form-label fw-bold small text-body mb-2"
        >Descripción breve</label
      >
      <textarea
        class="form-control border-0 shadow-sm rounded-3 p-3 text-secondary"
        rows="3"
        placeholder="Ej: Carga de Diesel en Estación Norte"
        formControlName="description"
      ></textarea>
    </div>

    <!-- Action Buttons -->
    <div class="d-grid gap-2">
      <button
        type="submit"
        class="btn btn-primary btn-lg rounded-3 fw-bold py-3"
      >
        <i class="fa-solid fa-check-circle me-2"></i> Registrar Gasto
      </button>
    </div>
  </form>
</div>
